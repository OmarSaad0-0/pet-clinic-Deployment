pipeline {

    agent any

    stages {
        stage('git branch') {
            steps {
                sh """
                pwd 
                if [[ -e spring-petclinic ]]            
                then
                    rm -r spring-petclinic
                fi
                """
                git branch: "main", url: "https://github.com/spring-projects/spring-petclinic.git"
            }
        }
        stage('CI') {
            steps {
                sh """
                #!/bin/bash

                # edit PetClinicApplication
                sed -i '/import org.springframework.web.servlet.i18n.SessionLocaleResolver;/a import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;' /home/saad/.jenkins/workspace/spring-petclinic/src/main/java/org/springframework/samples/petclinic/PetClinicApplication.java
                sed -i 's/public class PetClinicApplication {/public class PetClinicApplication extends SpringBootServletInitializer {/' /home/saad/.jenkins/workspace/spring-petclinic/src/main/java/org/springframework/samples/petclinic/PetClinicApplication.java

                # edit pom.xml
                sed -i '/<\\/parent>/a <packaging>war<\\/packaging>' /home/saad/.jenkins/workspace/spring-petclinic/pom.xml
                sed -i '0,/<\\/dependencies>/s#</dependencies>#<dependency>\\n    <groupId>org.springframework.boot</groupId>\\n    <artifactId>spring-boot-starter-tomcat</artifactId>\\n    <scope>provided</scope>\\n</dependency></dependencies>#' /home/saad/.jenkins/workspace/spring-petclinic/pom.xml

                ./mvnw spring-javaformat:apply
                ./mvnw clean package
                """
            }
        }
        stage('CD'){
            steps{

                sh '''
                #!/bin/bash
                server=$(cat '/home/saad/Blue-Green-deployment/CurrentActiveServer')
                if [ "$server" -eq 9091 ];
                then
                    if ls /home/saad/tomcat/webapps/*.war 1>/dev/null 2>&1;             
                    then
                        rm -r /home/saad/tomcat/webapps/spring-petclinic*
                    fi
                    mv /home/saad/.jenkins/workspace/spring-petclinic/target/*.war /home/saad/.jenkins/workspace/spring-petclinic/target/spring-petclinic.war
                    cp /home/saad/.jenkins/workspace/spring-petclinic/target/*.war ~/tomcat/webapps/
                    sudo cp /home/saad/Blue-Green-deployment/ActiveServer-9090/nginx.conf /usr/local/nginx/conf/nginx.conf
                    sudo /usr/local/nginx/sbin/nginx -s reload
                    echo "9090" > '/home/saad/Blue-Green-deployment/CurrentActiveServer'
                else
                    if ls /home/saad/GreenInstance/tomcat/webapps/*.war 1>/dev/null 2>&1;             
                    then
                        rm -r /home/saad/GreenInstance/tomcat/webapps/spring-petclinic*
                    fi
                    mv /home/saad/.jenkins/workspace/spring-petclinic/target/*.war /home/saad/.jenkins/workspace/spring-petclinic/target/spring-petclinic.war
                    cp /home/saad/.jenkins/workspace/spring-petclinic/target/*.war ~/GreenInstance/tomcat/webapps/
                    sudo cp /home/saad/Blue-Green-deployment/ActiveServer-9091/nginx.conf /usr/local/nginx/conf/nginx.conf
                    sudo /usr/local/nginx/sbin/nginx -s reload
                    echo "9091" > '/home/saad/Blue-Green-deployment/CurrentActiveServer'
                fi 
                
                '''

        }
      
    }}}

